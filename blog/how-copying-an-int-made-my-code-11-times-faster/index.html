<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Как копирование int сделало мой код в 11 раз быстрее | Dudochkin Victor </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="google-site-verification" content="Kepqb6k6uptlwngnHbBVJmqQtwNW8zfHyQBbTXLYAgA" />
    <meta name="yandex-verification" content="8e8bc73c2566b473" />
    <style>
    :root {
        /* Primary theme color */
        /* --primary-color: #121A26; */
        --primary-color: #0f1419;
        /* Primary theme text color */
        /* --primary-text-color: #121A26; */
        --primary-text-color: #0f1419;
        /* Primary theme link color */
        --primary-link-color: #053961;
        /* Secondary color: the background body color */
        --secondary-color: #F0F0F0;
        --secondary-text-color: #1C2834;
        /* Highlight text color of table of content */
        --toc-highlight-text-color: #053961;
    }
</style>
    
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-47MMPLLY44"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-47MMPLLY44');
    </script>
    

    
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
    
        ym('87064264', "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/87064264" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    
    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/mdl.min.css">
    <link rel="stylesheet" href="https://dudochkin-victor.github.io/style.css">
    
    
</head>

<body>
    
<header class="box-shadow">
    

<a href="https:&#x2F;&#x2F;dudochkin-victor.github.io&#x2F;">
    <div class="logo">
        <img src="https://dudochkin-victor.github.io/ferris.png" alt="logo">
        Dudochkin Victor
    </div>
</a>

<nav>
    <!-- 
    <a class="nav-item subtitle-text" href="https:&#x2F;&#x2F;dudochkin-victor.github.io&#x2F;showcases&#x2F;">Showcases</a>
    
    <a class="nav-item subtitle-text" href="https:&#x2F;&#x2F;dudochkin-victor.github.io&#x2F;changelog&#x2F;">Changelog</a>
    
    <a class="nav-item subtitle-text" href="https:&#x2F;&#x2F;dudochkin-victor.github.io&#x2F;about&#x2F;">About</a>
     -->

    
        
        <a class="nav-item subtitle-text" href="&#x2F;solana&#x2F;">Solana</a>
        
        <a class="nav-item subtitle-text" href="&#x2F;edgeware&#x2F;">Edgeware</a>
        
        <a class="nav-item subtitle-text" href="&#x2F;blog&#x2F;">Блог</a>
        
        <a class="nav-item subtitle-text" href="https:&#x2F;&#x2F;github.com&#x2F;dudochkin-victor">Github</a>
        
    
</nav>

</header>

 
    <main>
        
        
        
        
        
        <div class="toc">
            <div class="toc-sticky">
                
                <div class="toc-item">
                    <a class="subtext" href="https://dudochkin-victor.github.io/blog/how-copying-an-int-made-my-code-11-times-faster/#bonus-nepostoiannyi-razmer">Бонус: непостоянный размер</a>
                </div>
                
                
            </div>
        </div>
        
        

        <div class="content text">
            
<h1>Как копирование int сделало мой код в 11 раз быстрее</h1>

<p><a href="https://medium.com/@robertgrosse/how-copying-an-int-made-my-code-11-times-faster-f76c66312e0f">Перевод</a> | Автор оригинала: Robert Grosse</p>
<p>Недавно, после рефакторинга кода Rust, я заметил, что он внезапно стал в четыре раза медленнее. Однако странно то, что я даже не коснулся той части кода, которая стала медленнее. Более того, после комментирования изменений он все еще был медленнее. Из любопытства я решил продолжить расследование.</p>
<p>Первым шагом было использование git diff для отображения всех изменений с момента предыдущей фиксации, что было нормальной скоростью. Затем я начал удалять их один за другим, какими бы несущественными они ни были, и тестировать, чтобы убедиться, что после внесения изменений все еще было медленным.</p>
<p>В конце концов, я остался с различием только одного оператора печати, добавленного для несвязанных целей отладки, и, конечно же, комментирование оператора печати снова ускорило код. Обратите внимание, что этот оператор печати выполняется только один раз, и это даже не часть медленного кода. Единственное, о чем я мог думать, это то, что это каким-то образом нарушает оптимизацию компилятора, поэтому я решил попытаться свести его к минимальному примеру, чтобы сообщить об ошибке.</p>
<p>В конце концов, я сократил код до следующего: </p>
<pre data-lang="rust" style="background-color:#0f1419;color:#bfbab0;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ff7733;">fn </span><span style="color:#ffb454;">main</span><span>() {
</span><span>    </span><span style="color:#ff7733;">let</span><span> size </span><span style="color:#f29668;">= </span><span style="color:#f29718;">1</span><span style="color:#ff7733;">usize </span><span style="color:#f29668;">&lt;&lt; </span><span style="color:#f29718;">25</span><span style="color:#bfbab0cc;">;    </span><span style="font-style:italic;color:#5c6773;">// Adding this line causes program to go from 0.16 seconds to 1.7 seconds
</span><span>    </span><span style="color:#f07178;">println!</span><span>(</span><span style="color:#c2d94c;">&quot;</span><span style="color:#f29718;">{}</span><span style="color:#c2d94c;">&quot;</span><span style="color:#bfbab0cc;">,</span><span> size)</span><span style="color:#bfbab0cc;">;    </span><span style="color:#ff7733;">let mut</span><span> ints </span><span style="color:#f29668;">= </span><span style="color:#f07178;">vec!</span><span>[</span><span style="color:#f29718;">0</span><span style="color:#ff7733;">u32</span><span style="color:#bfbab0cc;">;</span><span> size]</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">for</span><span> i </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span>size {
</span><span>        </span><span style="color:#ff7733;">for</span><span> c </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span style="color:#f29718;">8</span><span style="color:#ff7733;">usize </span><span>{
</span><span>            ints[(i </span><span style="color:#f29668;">^</span><span> c) </span><span style="color:#f29668;">%</span><span> size] </span><span style="color:#f29668;">+= </span><span style="color:#f29718;">1</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>Добавление оператора печати приводит к тому, что код увеличивается с 0,16 секунды до 1,7 секунды, то есть замедление в 11 раз (в режиме выпуска). Затем я разместил его на IRC-канале rustc, где eddyb и bluss предложили обходной путь и объяснили, что происходит.</p>
<p>Исправление заключалось в изменении строки печати на следующую, что действительно устраняет замедление. </p>
<pre data-lang="rust" style="background-color:#0f1419;color:#bfbab0;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#f07178;">println!</span><span>(</span><span style="color:#c2d94c;">&quot;</span><span style="color:#f29718;">{}</span><span style="color:#c2d94c;">&quot;</span><span style="color:#bfbab0cc;">, </span><span>{size})</span><span style="color:#bfbab0cc;">;
</span></code></pre>
<p>{x} объявляет блок операторов, который вычисляет последнее выражение, в данном случае x. Это означает, что {x} совпадает с x с дополнительным перемещением / копией. Обычно это полезно только для обхода неявного повторного заимствования при передаче изменяемых ссылок. Однако здесь нет никаких заемных средств. Все, что он делает, - это копирование простого int, что кажется бесполезным.</p>
<p>Хитрость в том, что, как и все универсальные интерфейсы в Rust, печать принимает аргументы по ссылке, независимо от того, являются они копией или нет. Печать! макрос скрывает это от вас, неявно заимствуя аргументы, что вы можете увидеть, если rustc распечатает расширения макроса (обратите внимание на (&amp;size,). Если вам интересно, вот почему вы можете печатать не копируемые значения без явного заимствования им, в кажущемся нарушении системы собственности. </p>
<pre data-lang="rust" style="background-color:#0f1419;color:#bfbab0;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#bfbab0cc;">#!</span><span>[</span><span style="color:#ffb454;">feature</span><span>(prelude_import)]
</span><span style="color:#bfbab0cc;">#!</span><span>[</span><span style="color:#ffb454;">no_std</span><span>]
</span><span style="color:#bfbab0cc;">#</span><span>[</span><span style="color:#ffb454;">prelude_import</span><span>]
</span><span style="color:#ff7733;">use </span><span>std</span><span style="color:#f29668;">::</span><span>prelude</span><span style="color:#f29668;">::</span><span>v1</span><span style="color:#f29668;">::*</span><span style="color:#bfbab0cc;">;
</span><span style="color:#bfbab0cc;">#</span><span>[</span><span style="color:#ffb454;">macro_use</span><span>] </span><span style="color:#ff7733;">extern crate</span><span> std </span><span style="color:#f29668;">as</span><span> std</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span style="color:#ff7733;">fn </span><span style="color:#ffb454;">main</span><span>() {
</span><span>    </span><span style="color:#ff7733;">let</span><span> size </span><span style="color:#f29668;">= </span><span style="color:#f29718;">1</span><span style="color:#ff7733;">usize </span><span style="color:#f29668;">&lt;&lt; </span><span style="color:#f29718;">25</span><span style="color:#bfbab0cc;">;
</span><span>    
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// Adding this line causes program to go from 0.16 seconds to 1.7 seconds
</span><span>    
</span><span>    </span><span style="color:#f29668;">::</span><span>io</span><span style="color:#f29668;">::</span><span>_print(</span><span style="color:#f29668;">::</span><span>std</span><span style="color:#f29668;">::</span><span>fmt</span><span style="color:#f29668;">::</span><span>Arguments</span><span style="color:#f29668;">::</span><span>new_v1({
</span><span>                                                   </span><span style="color:#ff7733;">static </span><span style="color:#f29718;">__STATIC_FMTSTR</span><span style="color:#bfbab0cc;">:
</span><span>                                                          </span><span style="color:#f29668;">&amp;</span><span style="color:#ff7733;">&#39;static </span><span>[</span><span style="color:#f29668;">&amp;</span><span style="color:#ff7733;">&#39;static str</span><span>]
</span><span>                                                          </span><span style="color:#f29668;">=
</span><span>                                                       </span><span style="color:#f29668;">&amp;</span><span>[</span><span style="color:#c2d94c;">&quot;&quot;</span><span style="color:#bfbab0cc;">, </span><span style="color:#c2d94c;">&quot;</span><span style="color:#95e6cb;">\n</span><span style="color:#c2d94c;">&quot;</span><span>]</span><span style="color:#bfbab0cc;">;
</span><span>                                                   </span><span style="color:#f29718;">__STATIC_FMTSTR
</span><span>                                               }</span><span style="color:#bfbab0cc;">,
</span><span>                                               </span><span style="color:#f29668;">&amp;</span><span style="color:#ff7733;">match </span><span>(</span><span style="color:#f29668;">&amp;</span><span>size</span><span style="color:#bfbab0cc;">,</span><span>) {
</span><span>                                                    (__arg0</span><span style="color:#bfbab0cc;">,</span><span>) </span><span style="color:#f29668;">=&gt;
</span><span>                                                    [</span><span style="color:#f29668;">::</span><span>std</span><span style="color:#f29668;">::</span><span>fmt</span><span style="color:#f29668;">::</span><span>ArgumentV1</span><span style="color:#f29668;">::</span><span>new(__arg0</span><span style="color:#bfbab0cc;">,
</span><span>                                                                                 </span><span style="color:#f29668;">::</span><span>std</span><span style="color:#f29668;">::</span><span>fmt</span><span style="color:#f29668;">::</span><span>Display</span><span style="color:#f29668;">::</span><span>fmt)]</span><span style="color:#bfbab0cc;">,
</span><span>                                                }))</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">let mut</span><span> ints </span><span style="color:#f29668;">= ::</span><span>vec</span><span style="color:#f29668;">::</span><span>from_elem(</span><span style="color:#f29718;">0</span><span style="color:#ff7733;">u32</span><span style="color:#bfbab0cc;">,</span><span> size)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">for</span><span> i </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span>size { </span><span style="color:#ff7733;">for</span><span> c </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span style="color:#f29718;">8</span><span style="color:#ff7733;">usize </span><span>{ ints[(i </span><span style="color:#f29668;">^</span><span> c) </span><span style="color:#f29668;">%</span><span> size] </span><span style="color:#f29668;">+= </span><span style="color:#f29718;">1</span><span style="color:#bfbab0cc;">; </span><span>} }
</span><span>}
</span></code></pre>
<p>Передача {size} вместо size предотвращает println! от размера займа. Вместо этого он заимствует временную копию. Однако это все еще не объясняет, как заимствование вызывает такое сильное замедление. Другая половина истории заключается в том, что, хотя Rust знает, что заимствование неизменяемо, эта информация, к сожалению, не передается в LLVM. Это означает, что оптимизатор LLVM видит, что указатель на размер передается некоторой функции, и просто отказывается, оставив следующий код, предполагающий, что размер содержит произвольное значение. Вместо этого заимствование копии позволяет оптимизатору выполнять свою работу.</p>
<p>Вы также можете увидеть это, явно сбросив значение размера после возврата из вызова печати. Это снова делает код быстрым, потому что оптимизатор видит постоянное значение размера. </p>
<pre data-lang="rust" style="background-color:#0f1419;color:#bfbab0;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ff7733;">fn </span><span style="color:#ffb454;">main</span><span>() {
</span><span>    </span><span style="color:#ff7733;">let mut</span><span> size </span><span style="color:#f29668;">= </span><span style="color:#f29718;">1</span><span style="color:#ff7733;">usize </span><span style="color:#f29668;">&lt;&lt; </span><span style="color:#f29718;">25</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#f07178;">println!</span><span>(</span><span style="color:#c2d94c;">&quot;</span><span style="color:#f29718;">{}</span><span style="color:#c2d94c;">&quot;</span><span style="color:#bfbab0cc;">,</span><span> size)</span><span style="color:#bfbab0cc;">;
</span><span>    size </span><span style="color:#f29668;">= </span><span style="color:#f29718;">1</span><span style="color:#ff7733;">usize </span><span style="color:#f29668;">&lt;&lt; </span><span style="color:#f29718;">25</span><span style="color:#bfbab0cc;">;    </span><span style="color:#ff7733;">let mut</span><span> ints </span><span style="color:#f29668;">= </span><span style="color:#f07178;">vec!</span><span>[</span><span style="color:#f29718;">0</span><span style="color:#ff7733;">u32</span><span style="color:#bfbab0cc;">;</span><span> size]</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">for</span><span> i </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span>size {
</span><span>        </span><span style="color:#ff7733;">for</span><span> c </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span style="color:#f29718;">8</span><span style="color:#ff7733;">usize </span><span>{
</span><span>            ints[(i </span><span style="color:#f29668;">^</span><span> c) </span><span style="color:#f29668;">%</span><span> size] </span><span style="color:#f29668;">+= </span><span style="color:#f29718;">1</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>На этом этапе загадка была раскрыта, но мне было любопытно посмотреть, какие фактические различия в генерации кода вызывали разницу в скорости. Оказывается, можно попросить rustc распечатать и сборку. </p>
<pre style="background-color:#0f1419;color:#bfbab0;"><code><span>rustc -O --emit asm src/main.rs -C llvm-args=-x86-asm-syntax=intel
</span></code></pre>
<p>Определить внутренний цикл в сборке довольно легко, тем более что код в этом примере очень мал. Для оптимизированной версии {size} внутренний цикл выглядит следующим образом. </p>
<pre data-lang="asm" style="background-color:#0f1419;color:#bfbab0;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#ffb454;">.LBB0_3:
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">r14d</span><span>, </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rax </span><span>+ </span><span style="color:#f29718;">4</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;">.LBB0_2:
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f29718;">r14d
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rax</span><span>], </span><span style="color:#f29718;">r14d
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">1
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">2
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">4
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">5
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">6
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rax
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">rbx </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rcx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">33554431
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jne </span><span style="color:#ffb454;">.LBB0_3
</span></code></pre>
<p>Код практически настолько оптимален, насколько это возможно, если не считать удаления обращений к памяти (оптимизатор теоретически мог бы вычислить, что в этом игрушечном примере для int установлено значение 8, но, к счастью, это не так). В частности, операция% size и проверки границ во внутреннем цикле полностью оптимизированы, а условие внешнего цикла просто сравнивается с константой. Это возможно, потому что оптимизатор понимает, что размер является а) постоянным и б) степенью двойки, и, таким образом, поиск по небольшому значению не выйдет за пределы.</p>
<p>Напротив, соответствующий код для версии размера не оптимизирован, кроме разворачивания цикла. Он выполняет проверку по модулю и границам при каждом доступе, поскольку не знает, какой размер. </p>
<pre data-lang="asm" style="background-color:#0f1419;color:#bfbab0;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#ffb454;">.LBB0_6:
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">1
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">2
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">4
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">5
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">6
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rax</span><span>, </span><span style="color:#f29718;">7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">edx</span><span>, </span><span style="color:#f29718;">edx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">div </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rcx</span><span>, </span><span style="color:#f29718;">rdx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r14 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rdx</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jb </span><span style="color:#ffb454;">.LBB0_6
</span></code></pre>
<h2 id="bonus-nepostoiannyi-razmer">Бонус: непостоянный размер</h2>
<p>Увидев приведенный выше код, мне стало любопытно, будет ли оптимизация работать, когда размер - это неизвестная степень двойки. В конце концов, в реальном коде размер часто бывает переменным. Я не мог понять, как заставить rustc печатать красивую сборку при использовании зависимости от внешнего контейнера, поэтому вместо этого я смоделировал параметр opaque с помощью функции extern. Очевидно, это не связано, но для генерации сборки это не имеет значения. </p>
<pre data-lang="rust" style="background-color:#0f1419;color:#bfbab0;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ff7733;">extern </span><span>{
</span><span>    </span><span style="color:#ff7733;">fn </span><span style="color:#ffb454;">opaque</span><span>() </span><span style="color:#bfbab0cc;">-&gt; </span><span style="color:#ff7733;">usize</span><span style="color:#bfbab0cc;">;
</span><span>}</span><span style="color:#ff7733;">fn </span><span style="color:#ffb454;">main</span><span>() {
</span><span>    </span><span style="color:#ff7733;">let</span><span> bits </span><span style="color:#f29668;">= </span><span style="color:#f29718;">14 </span><span style="color:#f29668;">+ </span><span>(</span><span style="color:#ff7733;">unsafe</span><span>{</span><span style="color:#f07178;">opaque</span><span>()} </span><span style="color:#f29668;">&amp; </span><span style="color:#f29718;">15</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">let</span><span> size </span><span style="color:#f29668;">= </span><span style="color:#f29718;">1</span><span style="color:#ff7733;">usize </span><span style="color:#f29668;">&lt;&lt;</span><span> bits</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#f07178;">println!</span><span>(</span><span style="color:#c2d94c;">&quot;</span><span style="color:#f29718;">{}</span><span style="color:#c2d94c;">&quot;</span><span style="color:#bfbab0cc;">, </span><span>{size})</span><span style="color:#bfbab0cc;">;    </span><span style="color:#ff7733;">let mut</span><span> ints </span><span style="color:#f29668;">= </span><span style="color:#f07178;">vec!</span><span>[</span><span style="color:#f29718;">0</span><span style="color:#ff7733;">u32</span><span style="color:#bfbab0cc;">;</span><span> size]</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">for</span><span> i </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span>size {
</span><span>        </span><span style="color:#ff7733;">for</span><span> c </span><span style="color:#f29668;">in </span><span style="color:#f29718;">0</span><span style="color:#f29668;">..</span><span style="color:#f29718;">8</span><span style="color:#ff7733;">usize </span><span>{
</span><span>            ints[(i </span><span style="color:#f29668;">^</span><span> c) </span><span style="color:#f29668;">%</span><span> size] </span><span style="color:#f29668;">+= </span><span style="color:#f29718;">1</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>В любом случае, оказывается, что полученный код в основном неоптимизирован, хотя все же лучше, чем в предыдущем случае, когда размер мысли оптимизатора был неизвестен. </p>
<pre data-lang="asm" style="background-color:#0f1419;color:#bfbab0;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#ffb454;">.LBB0_2:
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">1
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">2
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">4
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">5
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">6
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">mov </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">xor </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">7
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">and </span><span style="color:#f29718;">rsi</span><span>, </span><span style="color:#f29718;">r13
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">r12</span><span>, </span><span style="color:#f29718;">rsi
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jbe </span><span style="color:#ffb454;">.LBB0_3
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f29718;">rbx
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">inc </span><span style="color:#f07178;">dword ptr </span><span>[</span><span style="color:#f29718;">r15 </span><span>+ </span><span style="color:#f29718;">4</span><span>*</span><span style="color:#f29718;">rsi</span><span>]
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">cmp </span><span style="color:#f29718;">rbx</span><span>, </span><span style="color:#f29718;">r12
</span><span style="color:#ffb454;"> </span><span style="color:#ff7733;">jb </span><span style="color:#ffb454;">.LBB0_2
</span></code></pre>
<p>В частности, он по-прежнему проверяет границы и по-прежнему выполняет часть размера %. Однако, по крайней мере, достаточно умен, чтобы выполнять побитовое деление по модулю вместо операции полного деления. С другой стороны, проверка границ далека от идеала. Это заставляет меня задуматься, стоит ли мономорфизировать критический для производительности код, подобный этому, и дублировать его для каждой возможной степени двойки, а затем включать размер для вызова одной из этих функций во время выполнения, чтобы получить полный потенциал оптимизации. </p>










<script src="https://giscus.app/client.js"
    data-repo="dudochkin-victor&#x2F;dudochkin-victor.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzNzgwNTYx"
    data-category="General"
    data-category-id="DIC_kwDOADmv0c4CAhvj"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
</script>



        </div>

        
        
    </main>

    
    <footer>
        <small class="subtext">
            <a href="https://angular-rust.github.io">Dudochkin Victor</a> © 2021
        </small>
    </footer>
    
</body>
<script>
    function highlightNav(heading) {
        let pathname = location.pathname;
        document.querySelectorAll(".toc a").forEach((item) => {
            item.classList.remove("active");
        });
        document.querySelector(".toc a[href$='" + pathname + "#" + heading + "']").classList.add("active");
    }

    let currentHeading = "";
    window.onscroll = function () {
        let h = document.querySelectorAll("h1,h2,h3,h4,h5,h6");
        let elementArr = [];

        h.forEach(item => {
            if (item.id !== "") {
                elementArr[item.id] = item.getBoundingClientRect().top;
            }
        });
        elementArr.sort();
        for (let key in elementArr) {
            if (!elementArr.hasOwnProperty(key)) {
                continue;
            }
            if (elementArr[key] > 0 && elementArr[key] < 300) {
                if (currentHeading !== key) {
                    highlightNav(key);
                    currentHeading = key;
                }
                break;
            }
        }
    }
</script>

</html>
